<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>สมุดวาดลายมือ - KruYee</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      /* เพิ่มโทนสีใหม่ที่สดใสและอบอุ่น */
      --color-primary: #5a7d9a; /* Steel Blue */
      --color-secondary: #f6d365; /* Saffron */
      --color-accent: #f59e0b; /* Amber */
      --color-text: #2c3e50; /* Dark Slate Gray */
      --color-card: #ffffff;
      --color-border: #e0e0e0;
      --color-danger: #e74c3c;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --border-radius: 12px;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background-image: url('https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_kv42wkkv42wkkv42.png');
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--color-text);
      padding: 24px;
      box-sizing: border-box;
    }

    .app-container {
      width: 100%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      background-color: rgba(255, 255, 255, 0.85); /* เพิ่มพื้นหลังโปร่งแสงเพื่อให้เนื้อหาอ่านง่ายขึ้น */
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    @media (min-width: 992px) {
      .app-container {
        grid-template-columns: 320px 1fr;
        padding: 40px;
      }
    }

    .toolbar-panel {
      background: var(--color-card);
      border-radius: var(--border-radius);
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 20px;
      border: 1px solid var(--color-border);
    }

    .toolbar-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toolbar-header {
      font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .color-swatch-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
      gap: 8px;
    }

    .color-dot {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid var(--color-border);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .color-dot:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    input[type="color"] {
      width: 100%;
      height: 48px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      padding: 0;
      background: transparent;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color-primary);
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .controls-row {
      display: flex;
      gap: 10px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--color-border);
      background: var(--color-card);
      color: var(--color-text);
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:hover:not(:disabled) {
      background: #f0f0f0;
      transform: translateY(-1px);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .btn.danger {
      background: var(--color-danger);
      color: white;
      border-color: var(--color-danger);
    }

    .btn.download {
      background: linear-gradient(90deg, #60a5fa, #34d399);
      color: var(--color-text);
      border: none;
    }

    .canvas-card {
      background: var(--color-card);
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
    }

    .canvas-wrap {
      flex: 1;
      min-height: 400px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: repeating-linear-gradient(0deg, #f8fafc 0 20px, #f1f5f9 20px 21px);
      box-shadow: inset 0 0 0 1px var(--color-border);
    }

    canvas#board {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
      background: transparent;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 13px;
      color: #6c757d;
      text-align: center;
    }

    .kbd {
      padding: 2px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f0f0f0;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="toolbar-panel">
      <div class="toolbar-group">
        <h1 style="font-size: 24px; font-weight: 700; color: var(--color-primary); margin: 0;">
          <i class="fa-solid fa-pen-ruler" style="color:var(--color-primary)"></i> สมุดวาดลายมือ
        </h1>
        <p style="font-size: 14px; color: #6c757d; margin: 0;">เครื่องมือวาดภาพดิจิทัลอย่างง่าย</p>
      </div>

      <div class="toolbar-group">
        <h2 class="toolbar-header"><i class="fa-solid fa-palette"></i> สีและขนาด</h2>
        <div class="controls-row">
            <input type="color" id="colorPicker" value="#2c3e50">
        </div>
        <div class="color-swatch-grid" id="swatch">
          <div class="color-dot" style="background:#2c3e50" data-color="#2c3e50" title="ดำเข้ม"></div>
          <div class="color-dot" style="background:#e74c3c" data-color="#e74c3c" title="แดง"></div>
          <div class="color-dot" style="background:#f1c40f" data-color="#f1c40f" title="เหลือง"></div>
          <div class="color-dot" style="background:#2ecc71" data-color="#2ecc71" title="เขียว"></div>
          <div class="color-dot" style="background:#3498db" data-color="#3498db" title="น้ำเงิน"></div>
          <div class="color-dot" style="background:#9b59b6" data-color="#9b59b6" title="ม่วง"></div>
          <div class="color-dot" style="background:#8e44ad" data-color="#8e44ad" title="ม่วงเข้ม"></div>
          <div class="color-dot" style="background:#ecf0f1" data-color="#ecf0f1" title="เทาอ่อน"></div>
        </div>
      </div>
      
      <div class="toolbar-group">
        <div class="controls-row" style="align-items:center;">
          <label style="font-size: 14px;"><i class="fa-solid fa-arrows-left-right-to-line"></i> ขนาด</label>
          <input type="range" id="sizeRange" min="1" max="60" step="1" value="8">
          <span id="sizeVal" style="width: 40px; text-align: right; font-size: 14px;">8 px</span>
        </div>
        <div class="controls-row" style="align-items:center;">
          <label style="font-size: 14px;"><i class="fa-solid fa-droplet"></i> ความทึบ</label>
          <input type="range" id="alphaRange" min="0.1" max="1" step="0.05" value="1">
          <span id="alphaVal" style="width: 40px; text-align: right; font-size: 14px;">100%</span>
        </div>
      </div>

      <div class="toolbar-group">
        <h2 class="toolbar-header"><i class="fa-solid fa-brush"></i> โหมด</h2>
        <div class="controls-row" id="modeSeg">
          <button class="btn active" id="penBtn" title="ปากกา (P)"><i class="fa-solid fa-pen"></i> ปากกา</button>
          <button class="btn" id="eraserBtn" title="ยางลบ (E)"><i class="fa-solid fa-eraser"></i> ยางลบ</button>
        </div>
      </div>
      
      <div class="toolbar-group">
        <h2 class="toolbar-header"><i class="fa-solid fa-tools"></i> การกระทำ</h2>
        <div class="controls-row">
          <button class="btn" id="undoBtn" title="Undo (Ctrl/⌘+Z)"><i class="fa-solid fa-rotate-left"></i> ย้อนกลับ</button>
          <button class="btn" id="redoBtn" title="Redo (Ctrl/⌘+Shift+Z)"><i class="fa-solid fa-rotate-right"></i> ทำซ้ำ</button>
        </div>
        <div class="controls-row">
          <button class="btn danger" id="clearBtn" title="ล้างผืนผ้าใบ"><i class="fa-solid fa-broom"></i> ล้าง</button>
        </div>
      </div>

      <div class="toolbar-group">
        <h2 class="toolbar-header"><i class="fa-solid fa-download"></i> ดาวน์โหลด</h2>
        <div class="controls-row">
          <button class="btn download" id="savePNG"><i class="fa-solid fa-file-image"></i> PNG</button>
          <button class="btn download" id="saveJPG"><i class="fa-solid fa-file-image"></i> JPG</button>
        </div>
      </div>
    </div>

    <div class="canvas-card">
      <div class="canvas-wrap" id="canvasWrap">
        <canvas id="board"></canvas>
      </div>
      <div class="footer-note">
        <p>© 2025 โปรแกรมวาดลายมือ - พัฒนาโดยครูยีร์สอนคอม</p>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const canvas = document.getElementById('board');
      const wrap   = document.getElementById('canvasWrap');
      const ctx    = canvas.getContext('2d');

      const colorPicker = document.getElementById('colorPicker');
      const sizeRange   = document.getElementById('sizeRange');
      const alphaRange  = document.getElementById('alphaRange');
      const sizeVal     = document.getElementById('sizeVal');
      const alphaVal    = document.getElementById('alphaVal');
      const swatch      = document.getElementById('swatch');

      const penBtn    = document.getElementById('penBtn');
      const eraserBtn = document.getElementById('eraserBtn');
      const undoBtn   = document.getElementById('undoBtn');
      const redoBtn   = document.getElementById('redoBtn');
      const clearBtn  = document.getElementById('clearBtn');
      const savePNG   = document.getElementById('savePNG');
      const saveJPG   = document.getElementById('saveJPG');

      let isDrawing = false;
      let dpr = Math.max(1, window.devicePixelRatio || 1);
      let mode = 'pen';
      let lastPoint = null;

      // History
      const history = [];
      const redoStack = [];
      const MAX_HISTORY = 50;

      function hexToRgb(hex) {
        const s = hex.replace('#', '');
        const bigint = parseInt(s.length === 3 ? s.split('').map(c => c + c).join('') : s, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return { r, g, b };
      }

      function setMode(newMode) {
        mode = newMode;
        penBtn.classList.toggle('active', mode === 'pen');
        eraserBtn.classList.toggle('active', mode === 'eraser');
        ctx.globalCompositeOperation = (mode === 'pen') ? 'source-over' : 'destination-out';
      }

      function resizeCanvas() {
        const rect = wrap.getBoundingClientRect();
        const cssWidth = Math.max(100, rect.width);
        const cssHeight = Math.max(200, rect.height);
        
        const oldCanvas = ctx.getImageData(0, 0, canvas.width / dpr, canvas.height / dpr);

        canvas.width = Math.round(cssWidth * dpr);
        canvas.height = Math.round(cssHeight * dpr);
        canvas.style.width = cssWidth + 'px';
        canvas.style.height = cssHeight + 'px';

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);
        
        ctx.putImageData(oldCanvas, 0, 0);
      }

      function pushSnapshot() {
        try {
          const data = ctx.getImageData(0, 0, canvas.width / dpr, canvas.height / dpr);
          history.push(data);
          if (history.length > MAX_HISTORY) history.shift();
          redoStack.length = 0;
          updateUndoRedoState();
        } catch (e) {
          console.warn('snapshot failed:', e);
        }
      }

      function restoreFromTop() {
        if (history.length) {
          const img = history[history.length - 1];
          ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
          ctx.putImageData(img, 0, 0);
        } else {
          clearCanvas(false);
        }
      }

      function updateUndoRedoState() {
        undoBtn.disabled = history.length <= 1;
        redoBtn.disabled = redoStack.length === 0;
      }

      function undo() {
        if (history.length > 1) {
          const last = history.pop();
          redoStack.push(last);
          restoreFromTop();
          updateUndoRedoState();
        }
      }

      function redo() {
        if (redoStack.length) {
          const next = redoStack.pop();
          history.push(next);
          restoreFromTop();
          updateUndoRedoState();
        }
      }

      function clearCanvas(addToHistory = true) {
        ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
        if (addToHistory) pushSnapshot();
      }

      function startDraw(e) {
        isDrawing = true;
        canvas.setPointerCapture?.(e.pointerId);
        lastPoint = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastPoint.x, lastPoint.y);
        drawStroke(e);
      }

      function drawStroke(e) {
        if (!isDrawing) return;
        const currentPoint = getPos(e);
        
        const { r, g, b } = hexToRgb(colorPicker.value);
        const opacity = parseFloat(alphaRange.value || '1');
        const width = parseInt(sizeRange.value || '8', 10);

        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = width;
        ctx.strokeStyle = `rgba(${r},${g},${b},${opacity})`;
        
        ctx.lineTo(currentPoint.x, currentPoint.y);
        ctx.stroke();
        
        lastPoint = currentPoint;
        e.preventDefault();
      }

      function endDraw() {
        if (!isDrawing) return;
        isDrawing = false;
        ctx.closePath();
        pushSnapshot();
      }

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
      }

      // Download
      function downloadDataUrl(dataUrl, filename) {
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      function saveAsPNG() {
        const dataUrl = canvas.toDataURL('image/png');
        const name = `drawing-${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
        downloadDataUrl(dataUrl, name);
      }

      function saveAsJPG() {
        const w = canvas.width, h = canvas.height;
        const tmp = document.createElement('canvas');
        tmp.width = w;
        tmp.height = h;
        const tctx = tmp.getContext('2d');
        tctx.fillStyle = '#ffffff';
        tctx.fillRect(0, 0, w, h);
        tctx.drawImage(canvas, 0, 0);
        const dataUrl = tmp.toDataURL('image/jpeg', 0.95);
        const name = `drawing-${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;
        downloadDataUrl(dataUrl, name);
      }

      // Events
      const ro = new ResizeObserver(() => { resizeCanvas(); });
      ro.observe(wrap);

      swatch.addEventListener('click', (e) => {
        const dot = e.target.closest('.color-dot');
        if (!dot) return;
        const c = dot.dataset.color;
        if (c) {
          colorPicker.value = c;
        }
      });

      sizeRange.addEventListener('input', () => sizeVal.textContent = `${sizeRange.value} px`);
      alphaRange.addEventListener('input', () => alphaVal.textContent = `${Math.round(alphaRange.value * 100)}%`);

      penBtn.addEventListener('click', () => setMode('pen'));
      eraserBtn.addEventListener('click', () => setMode('eraser'));

      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);

      // SweetAlert2
      clearBtn.addEventListener('click', () => {
        Swal.fire({
          title: 'ต้องการล้างผืนผ้าใบ?',
          text: 'คุณจะไม่สามารถย้อนกลับการกระทำนี้ได้',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'ใช่, ล้างเลย!',
          cancelButtonText: 'ยกเลิก'
        }).then((result) => {
          if (result.isConfirmed) {
            clearCanvas(true);
            Swal.fire({
                title: 'ล้างเรียบร้อย!',
                text: 'ผืนผ้าใบของคุณถูกล้างแล้ว',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
          }
        });
      });

      savePNG.addEventListener('click', saveAsPNG);
      saveJPG.addEventListener('click', saveAsJPG);

      canvas.addEventListener('pointerdown', startDraw);
      canvas.addEventListener('pointermove', drawStroke);
      window.addEventListener('pointerup', endDraw);
      canvas.addEventListener('pointerleave', endDraw);

      window.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'p') setMode('pen');
        if (e.key.toLowerCase() === 'e') setMode('eraser');
        const isMac = navigator.platform.toUpperCase().includes('MAC');
        const ctrl = isMac ? e.metaKey : e.ctrlKey;
        if (ctrl && e.key.toLowerCase() === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
        if (ctrl && e.key.toLowerCase() === 'z' && e.shiftKey) { e.preventDefault(); redo(); }
      });

      // Initial setup
      setMode('pen');
      sizeVal.textContent = `${sizeRange.value} px`;
      alphaVal.textContent = `${Math.round(alphaRange.value * 100)}%`;
      resizeCanvas();
      pushSnapshot();
      updateUndoRedoState();
    })();
  </script>
</body>
</html>
